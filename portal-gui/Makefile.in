# $Id$
#
# @configure_input@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@
srcdir=@srcdir@
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
localstatedir=@localstatedir@
sharedstatedir=@sharedstatedir@
bindir=@bindir@
sbindir=@sbindir@
libexecdir=@libexecdir@

PYTHON=@PYTHON@
WEBUSER=@WEBUSER@
DJANGO_ADMIN=@DJANGO_ADMIN@

CONFDIR=$(localstatedir)/rpki/conf
DATABASE_PATH=$(localstatedir)/rpki/gui.db
INSTDIR=$(datarootdir)/rpki/gui
TEMPLATEDIR=$(INSTDIR)/templates

# automatically built sources
BUILD=\
	scripts/list_resources \
	scripts/adduser \
	scripts/load_csv \
	apache/rpki.conf

all: $(BUILD)

clean:
	@true

distclean: clean
	rm -f $(BUILD)
	rm -f Makefile

edit = sed \
	     -e 's|@PYTHON[@]|$(PYTHON)|g' \
	     -e 's|@WEBUSER[@]|$(WEBUSER)|g'

apache/rpki.conf: $(srcdir)/apache/rpki.conf.in Makefile
	$(edit) $@.in > $@

scripts/list_resources: $(srcdir)/scripts/list_resources.py Makefile
	$(edit) $@.py > $@

scripts/load_csv: $(srcdir)/scripts/load_csv.py Makefile
	$(edit) $@.py > $@

scripts/adduser: $(srcdir)/scripts/adduser.py Makefile
	$(edit) $@.py > $@

.PHONY: install-perms install-data install install-scripts install-templates

install-perms:
	chown $(WEBUSER) `dirname $(DATABASE_PATH)`
	chown $(WEBUSER) $(DATABASE_PATH)
	mkdir -p $(CONFDIR)
	chown -R $(WEBUSER) $(CONFDIR)

install-apache:
	install -d -m 755 $(INSTDIR)/apache
	install -m 644 apache/rpki.conf $(INSTDIR)/apache
	install -m 644 apache/rpki.wsgi $(INSTDIR)/apache

install-templates:
	install -d -m 755 $(TEMPLATEDIR)/myrpki
	install -m 644 templates/base.html $(TEMPLATEDIR)
	install -m 644 templates/myrpki/asn_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/child_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/conf_empty.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/conf_list.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/dashboard.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/parent_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/prefix_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/xml_import.html $(TEMPLATEDIR)/myrpki
	install -d -m 755 $(TEMPLATEDIR)/registration
	install -m 644 templates/registration/login.html $(TEMPLATEDIR)/registration

install-scripts:
	# user scripts
	install -m 755 scripts/load_csv $(sbindir)/rpkigui-load-csv
	install -m 755 scripts/adduser $(sbindir)/rpkigui-add-user
	install -D -m 755 scripts/list_resources $(libexecdir)/rpkigui-list-resources

install-data: $(BUILD) install-apache install-templates install-scripts
	mkdir -p `dirname $(DATABASE_PATH)`
	$(DJANGO_ADMIN) syncdb --settings rpki.gui.settings

install: install-data install-perms

deinstall uninstall:
	rm -r $(INSTDIR)
	rm $(sbindir)/rpkigui-load-csv
	rm $(sbindir)/rpkigui-add-user
	rm $(libexecdir)/rpkigui-list-resources

test:
	@true

# $Id$
#
# @configure_input@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@
srcdir=@srcdir@

# where to install the portal-gui
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
localstatedir=@localstatedir@
sharedstatedir=@sharedstatedir@
bindir=@bindir@
sbindir=@sbindir@

PYTHON=@PYTHON@
WEBUSER=@WEBUSER@
CONFDIR=@CONFDIR@
SECRET_KEY=@SECRET_KEY@

INSTDIR=$(datarootdir)/portal-gui
DATABASE_PATH=$(localstatedir)/portal-gui/rpkigui.db
MYRPKI=$(sbindir)/myrpki
MEDIADIR=$(INSTDIR)/media
TEMPLATEDIR=$(INSTDIR)/rpkigui/templates

# automatically built sources
BUILD=rpkigui/settings.py \
      rpkigui/urls.py \
	scripts/adduser \
	scripts/list_resources \
	scripts/load_csv \
      apache/rpki.wsgi \
      apache/rpki.conf

all: $(BUILD)

clean:
	@true

distclean: clean
	rm -f rpkigui/settings.py rpkigui/urls.py
	rm -f apache/rpki.wsgi apache/rpki.conf
	rm -f Makefile

edit = sed \
	     -e 's|@CONFDIR[@]|$(CONFDIR)|g' \
	     -e 's|@DATABASE_PATH[@]|$(DATABASE_PATH)|g' \
	     -e 's|@INSTDIR[@]|$(INSTDIR)|g' \
	     -e 's|@MEDIADIR[@]|$(MEDIADIR)|g' \
	     -e 's|@MYRPKI[@]|$(MYRPKI)|g' \
	     -e 's|@PYTHON[@]|$(PYTHON)|g' \
	     -e 's|@SECRET_KEY[@]|$(SECRET_KEY)|g' \
	     -e 's|@TEMPLATEDIR[@]|$(TEMPLATEDIR)|g' \
	     -e 's|@WEBUSER[@]|$(WEBUSER)|g'

rpkigui/settings.py: $(srcdir)/rpkigui/settings.py.in Makefile
	$(edit) $@.in > $@

rpkigui/urls.py: $(srcdir)/rpkigui/urls.py.in Makefile
	$(edit) $@.in > $@

apache/rpki.wsgi: $(srcdir)/apache/rpki.wsgi.in Makefile
	$(edit) $@.in > $@

apache/rpki.conf: $(srcdir)/apache/rpki.conf.in Makefile
	$(edit) $@.in > $@

scripts/list_resources: $(srcdir)/scripts/list_resources.py Makefile
	$(edit) $@.py > $@

scripts/load_csv: $(srcdir)/scripts/load_csv.py Makefile
	$(edit) $@.py > $@

scripts/adduser: $(srcdir)/scripts/adduser.py Makefile
	$(edit) $@.py > $@

INSTALL_FILES=\
	apache/rpki.wsgi \
	media/img/my.png \
	media/img/rpki.png \
	rpkigui/__init__.py \
	rpkigui/manage.py \
	rpkigui/settings.py \
	rpkigui/urls.py \
	rpkigui/myrpki/AllocationTree.py \
	rpkigui/myrpki/__init__.py \
	rpkigui/myrpki/admin.py \
	rpkigui/myrpki/asnset.py \
	rpkigui/myrpki/forms.py \
	rpkigui/myrpki/glue.py \
	rpkigui/myrpki/misc.py \
	rpkigui/myrpki/models.py \
	rpkigui/myrpki/urls.py \
	rpkigui/myrpki/views.py \
	rpkigui/templates/base.html \
	rpkigui/templates/myrpki/asn_view.html \
	rpkigui/templates/myrpki/child_view.html \
	rpkigui/templates/myrpki/conf_empty.html \
	rpkigui/templates/myrpki/conf_list.html \
	rpkigui/templates/myrpki/dashboard.html \
	rpkigui/templates/myrpki/parent_view.html \
	rpkigui/templates/myrpki/prefix_view.html \
	rpkigui/templates/myrpki/xml_import.html \
	rpkigui/templates/registration/login.html \
	scripts/adduser \
	scripts/list_resources \
	scripts/load_csv

.PHONY: install-perms install-data install

install-perms:
	chown $(WEBUSER) `dirname $(DATABASE_PATH)`
	chown $(WEBUSER) $(DATABASE_PATH)
	chown -R $(WEBUSER) $(CONFDIR)

install-data: $(BUILD)
	mkdir -p `dirname $(DATABASE_PATH)`
	mkdir -p $(INSTDIR)/apache
	mkdir -p $(INSTDIR)/media/img
	mkdir -p $(INSTDIR)/rpkigui/myrpki
	mkdir -p $(INSTDIR)/rpkigui/templates/myrpki
	mkdir -p $(INSTDIR)/rpkigui/templates/registration
	mkdir -p $(INSTDIR)/scripts
	for f in $(INSTALL_FILES); do \
		install $$f $(INSTDIR)/$$f; \
	done
	cd $(INSTDIR)/rpkigui && $(PYTHON) manage.py syncdb

install: install-data install-perms

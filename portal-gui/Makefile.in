# $Id$
#
# @configure_input@

srcdir=@srcdir@

# where to install the portal-gui
INSTDIR=@INSTDIR@

PYTHON=@PYTHON@
MYRPKIDIR=@MYRPKIDIR@
DATABASE_PATH=@DATABASE_PATH@

# automatically built sources
BUILD=$(srcdir)/configure Makefile config.status rpkigui/settings.py \
      rpkigui/urls.py scripts/helper scripts/runserver apache/django.wsgi \
      apache/zmyrpki.conf

all: $(BUILD)

$(srcdir)/configure: configure.ac
	cd '$(srcdir)' && autoconf
 
Makefile: $(srcdir)/Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

rpkigui/settings.py: $(srcdir)/rpkigui/settings.py.in
	./config.status

rpkigui/urls.py: $(srcdir)/rpkigui/urls.py.in
	./config.status

scripts/helper: $(srcdir)/scripts/helper.in
	./config.status

scripts/runserver: $(srcdir)/scripts/runserver.in
	./config.status

apache/django.wsgi: $(srcdir)/apache/django.wsgi.in
	./config.status

apache/zmyrpki.conf: $(srcdir)/apache/zmyrpki.conf.in
	./config.status

INSTALL_FILES=\
	apache/django.wsgi \
	media/img/my.png \
	media/img/rpki.png \
	rpkigui/__init__.py \
	rpkigui/manage.py \
	rpkigui/settings.py \
	rpkigui/urls.py \
	rpkigui/myrpki/AllocationTree.py \
	rpkigui/myrpki/__init__.py \
	rpkigui/myrpki/admin.py \
	rpkigui/myrpki/asnset.py \
	rpkigui/myrpki/forms.py \
	rpkigui/myrpki/glue.py \
	rpkigui/myrpki/misc.py \
	rpkigui/myrpki/models.py \
	rpkigui/myrpki/urls.py \
	rpkigui/myrpki/views.py \
	rpkigui/templates/base.html \
	rpkigui/templates/myrpki/asn_view.html \
	rpkigui/templates/myrpki/child_view.html \
	rpkigui/templates/myrpki/conf_empty.html \
	rpkigui/templates/myrpki/conf_list.html \
	rpkigui/templates/myrpki/dashboard.html \
	rpkigui/templates/myrpki/parent_view.html \
	rpkigui/templates/myrpki/prefix_view.html \
	rpkigui/templates/myrpki/xml_import.html \
	rpkigui/templates/registration/login.html \
	scripts/adduser.py \
	scripts/helper \
	scripts/list_resources.py \
	scripts/load_csv.py \
	scripts/runserver

install: $(BUILD)
	mkdir -p `dirname $(DATABASE_PATH)`
	mkdir -p $(INSTDIR)/apache
	mkdir -p $(INSTDIR)/media/img
	mkdir -p $(INSTDIR)/rpkigui/myrpki
	mkdir -p $(INSTDIR)/rpkigui/templates/myrpki
	mkdir -p $(INSTDIR)/rpkigui/templates/registration
	mkdir -p $(INSTDIR)/scripts
	for f in $(INSTALL_FILES); do \
		install $$f $(INSTDIR)/$$f; \
	done
	ln -sf $(INSTDIR)/scripts/helper $(INSTDIR)/scripts/load_csv
	ln -sf $(INSTDIR)/scripts/helper $(INSTDIR)/scripts/list_resources
	ln -sf $(INSTDIR)/scripts/helper $(INSTDIR)/scripts/adduser
	chmod 755 $(INSTDIR)/scripts/load_csv $(INSTDIR)/scripts/list_resources $(INSTDIR)/scripts/runserver $(INSTDIR)/scripts/adduser
	cd $(INSTDIR)/rpkigui && $(PYTHON) manage.py syncdb --pythonpath=$(MYRPKIDIR)


# $Id$

NAME = rcynic

BIN = ${NAME}
SRC = ${NAME}.c
OBJ = ${NAME}.o

HDR = defasn1.h
GEN = defstack.h

OBJS = ${OBJ} bio_f_linebreak.o

CFLAGS = @CFLAGS@ -Wall -Wshadow -Wmissing-prototypes -Wmissing-declarations -Werror-implicit-function-declaration
LDFLAGS = @LDFLAGS@ @LD_STATIC_FLAG@
LIBS = @LIBS@

AWK = @AWK@
PYTHON = @PYTHON@
RRDTOOL = @RRDTOOL@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@

host_os = @host_os@

SCRIPTS = rcynic-text rcynic-html

all: ${BIN} ${SCRIPTS}

clean:
	cd static-rsync; ${MAKE} $@
	rm -f ${BIN} ${OBJS} ${GEN} ${SCRIPTS}

${OBJ}: ${SRC} ${HDR} ${GEN}

${BIN}: ${OBJS}
	${CC} ${CFLAGS} -o $@ ${OBJS} ${LDFLAGS} ${LIBS}

defstack.h: defstack.awk ${SRC} ${HDR}
	${AWK} -f >$@ defstack.awk ${SRC} ${HDR}

test: ${BIN}
	if test -r rcynic.conf; \
	then \
		./${BIN} -j 0 && \
		test -r rcynic.xml && \
		echo && \
		./rcynic-text rcynic.xml; \
	else \
		 echo No rcynic.conf, skipping test; \
	fi

install: ${BIN} installation-scripts/install.sh
	cd installation-scripts; host_os="${host_os}"; DESTDIR="${DESTDIR}"; . ./install.sh

uninstall deinstall:
	cd installation-scripts; host_os="${host_os}"; DESTDIR="${DESTDIR}"; . ./deinstall.sh

distclean: clean
	cd static-rsync; ${MAKE} $@
	rm -f show.sh installation-scripts/linux/install.sh Makefile

COMPILE_PYTHON = \
	AC_PYTHON_INTERPRETER='${PYTHON}' \
	AC_RRDTOOL_BINARY='${RRDTOOL}' \
	${PYTHON} ${abs_top_srcdir}/buildtools/make-rcynic-script.py <$? >$@; \
	chmod 755 $@

rcynic-text: rcynic-text.py
	${COMPILE_PYTHON}

rcynic-html: rcynic-html.py
	${COMPILE_PYTHON}

tags: TAGS

TAGS: ${SRC} ${HDR} ${GEN}
	etags ${SRC} ${HDR} ${GEN}

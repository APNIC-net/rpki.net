# $Id$

NAME = rcynic

BIN = ${NAME}
SRC = ${NAME}.c
OBJ = ${NAME}.o

GEN = defstack.h

OBJS = ${OBJ} bio_f_linebreak.o

CFLAGS = @CFLAGS@ -Wall -Wshadow -Wmissing-prototypes -Wmissing-declarations -Werror-implicit-function-declaration
LDFLAGS = @LDFLAGS@ @LD_STATIC_FLAG@
LIBS = @LIBS@

AWK = @AWK@
PYTHON = @PYTHON@
RRDTOOL = @RRDTOOL@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@

host_os = @host_os@

SCRIPTS = rcynic-text rcynic-html rcynic-svn validation_status

all: ${BIN} ${SCRIPTS}

clean:
	cd static-rsync; ${MAKE} $@
	rm -f ${BIN} ${OBJS} ${SCRIPTS}

${OBJ}: ${SRC} ${GEN}

${BIN}: ${OBJS}
	${CC} ${CFLAGS} -o $@ ${OBJS} ${LDFLAGS} ${LIBS}

${GEN}: ${SRC}
	${PYTHON} ${abs_top_srcdir}/buildtools/defstack.py ${SRC} >$@.tmp
	mv $@.tmp $@

test: ${BIN}
	if test -r rcynic.conf; \
	then \
		./${BIN} -j 0 && \
		test -r rcynic.xml && \
		echo && \
		./rcynic-text rcynic.xml; \
	else \
		 echo No rcynic.conf, skipping test; \
	fi

install: ${BIN} installation-scripts/install.sh
	cd installation-scripts; host_os="${host_os}"; DESTDIR="${DESTDIR}"; . ./install.sh

uninstall deinstall:
	cd installation-scripts; host_os="${host_os}"; DESTDIR="${DESTDIR}"; . ./deinstall.sh

distclean: clean
	cd static-rsync; ${MAKE} $@
	rm -f installation-scripts/linux/install.sh Makefile

COMPILE_PYTHON = \
	AC_PYTHON_INTERPRETER='${PYTHON}' \
	AC_RRDTOOL_BINARY='${RRDTOOL}' \
	${PYTHON} ${abs_top_srcdir}/buildtools/make-rcynic-script.py <$? >$@; \
	chmod 755 $@

rcynic-text: rcynic-text.py
	${COMPILE_PYTHON}

rcynic-html: rcynic-html.py
	${COMPILE_PYTHON}

rcynic-svn: rcynic-svn.py
	${COMPILE_PYTHON}

validation_status: validation_status.py
	${COMPILE_PYTHON}

tags: TAGS

TAGS: ${SRC} ${GEN}
	etags ${SRC} ${GEN}

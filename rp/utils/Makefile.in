# $Id$

CFLAGS		= @CFLAGS@
LDFLAGS		= @LDFLAGS@
LIBS		= @LIBS@

INSTALL		= @INSTALL@ -m 555 

prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
datadir		= @datadir@
localstatedir	= @localstatedir@
sharedstatedir	= @sharedstatedir@
sysconfdir	= @sysconfdir@
bindir		= @bindir@
sbindir		= @sbindir@
libexecdir	= @libexecdir@
libdir		= @libdir@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@

BINS		= find_roa hashdir print_rpki_manifest print_roa scan_roas uri

SCRIPTS		= scan_routercerts find-roa-expiration

all:: ${BINS}

clean::
	rm -rf ${BINS} *.o *.dSYM

install:: all
	if test -d ${DESTDIR}${bindir} ; then :; else ${INSTALL} -d ${DESTDIR}${bindir}; fi
	${INSTALL} ${BINS} ${SCRIPTS} ${DESTDIR}${bindir}

deinstall uninstall::
	for i in ${BINS} ${SCRIPTS}; do rm -f ${DESTDIR}${bindir}/$$i; done

distclean:: clean
	rm -f Makefile

find_roa: find_roa.c
	${CC} ${CFLAGS} -o $@ find_roa.c ${LDFLAGS} ${LIBS}

hashdir: hashdir.c
	${CC} ${CFLAGS} -o $@ hashdir.c ${LDFLAGS} ${LIBS}

print_roa: print_roa.c
	${CC} ${CFLAGS} -o $@ print_roa.c ${LDFLAGS} ${LIBS}

print_rpki_manifest: print_rpki_manifest.c
	${CC} ${CFLAGS} -o $@ print_rpki_manifest.c ${LDFLAGS} ${LIBS}

scan_roas: scan_roas.c
	${CC} ${CFLAGS} -o $@ scan_roas.c ${LDFLAGS} ${LIBS}

uri: uri.c
	${CC} ${CFLAGS} -o $@ uri.c ${LDFLAGS} ${LIBS}

# Tests

RSYNC_AUTH_DIR	= ${abs_top_builddir}/rp/rcynic/rcynic-data/authenticated
HASHDIR_OUTPUT	= hashed-pem-dir
TARGET_PREFIXES	= 10.3.0.44 10.2.0.6 10.0.0.0/24

test:: ${BINS} ${SCRIPTS}
	if test -d ${RSYNC_AUTH_DIR}; \
	then \
	    rm -rf ${HASHDIR_OUTPUT} ; \
	    mkdir  ${HASHDIR_OUTPUT} ; \
	    ./hashdir  ${RSYNC_AUTH_DIR} ${HASHDIR_OUTPUT}; \
	    ./find_roa ${RSYNC_AUTH_DIR} ${TARGET_PREFIXES} ; \
	    date -u +'now:            %Y%m%d%H%M%SZ' || : ; \
	    find ${RSYNC_AUTH_DIR} -type f -name '*.roa' -print -exec ./print_roa           {} \; ; \
	    find ${RSYNC_AUTH_DIR} -type f -name '*.mft' -print -exec ./print_rpki_manifest {} \; ; \
	    ./scan_roas        ${RSYNC_AUTH_DIR} ; \
	    ./scan_routercerts ${RSYNC_AUTH_DIR} ; \
	fi

clean::
	rm -rf ${HASHDIR_OUTPUT}

{% extends "app/app_base.html" %}
{% load bootstrap_pager %}
{% load app_extras %}

{% block content %}

<div class='page-header'>
  <h1>Route View</h1>
</div>

<p>
This view shows currently advertised routes for the prefixes listed in resource certs received from RPKI parents.
<p>
BGP data from routeviews.org last updated {{ timestamp.bgp_v4_import.isoformat }}.<br/>
RPKI data last updated {{ timestamp.rcynic_import.isoformat }}.

<form method="POST" action="{% url "suggest-roas" %}">
  {% csrf_token %}
  <table class='table table-condensed'>
    <thead>
      <tr>
	<th>#</th>
	<th>Prefix</th>
	<th>Origin AS</th>
	<th>Validation Status</th>
      </tr>
    </thead>
    <tbody>
      {% for r in routes %}
      <tr>
	<td><input type="checkbox" name="pk-{{ r.pk }}"></td>
	<td>{{ r.get_prefix_display }}</td>
	<td>{{ r.asn }}</td>
	<td>
	  <span class="label label-{% validity_css_class r.status %}" data-toggle="popover" data-prefix="{{ r.get_prefix_display}}">{{ r.status }}</span>

	</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

    <button type="submit" class="btn btn-default" title="create ROAs for selected routes"><span class="glyphicon glyphicon-plus-sign"></span> Create ROAs</button>

</form>

{% bootstrap_pager request routes %}

{% endblock content %}

{# loaded after js scripts #}
{% block script %}
<script>
$('[data-toggle="popover"]').on('mouseenter', function () {
    var po = $(this);

    if ($(po).data('content') == null) {

    $.getJSON("/api/v1/roa/", {"prefix": $(this).attr("data-prefix")}, function (data) {
      var items = ['<table class="table table-default"><thead><tr><th>Prefix</th><th>Max Length</th><th>ASN</th></tr><tbody>'];
      $.each(data, function(idx, obj) {
	items.push('<tr><td>' + obj.prefix + '</td><td>' + obj.max_length + '</td><td>' + obj.asn + '</td></tr>');
	})
      items.push('</tbody></table>');

      $(po).data('content', items.join(""));

      $(po).popover({
	'title': 'Covering ROAs',
	'html': true,
	'placement': 'right',
	'trigger': 'manual',
	});
      $(po).popover('show');

      })
    } else {
      $(po).popover('show');
    }

    })

$('[data-toggle="popover"]').on('mouseout', function () {
    $(this).popover('hide');
    })

</script>
{% endblock %}

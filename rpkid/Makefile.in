# $Id$

PYTHON = @PYTHON@
PYWRAP = @PYWRAP@
PYWRAP_CMD = @PYWRAP_CMD@

SECRET_KEY = @SECRET_KEY@
WEBUSER = @WEBUSER@

CFLAGS	= @CFLAGS@
LDFLAGS = @LDFLAGS@
LIBS	= @LIBS@

prefix		= @prefix@
exec_prefix	= @exec_prefix@
datarootdir	= @datarootdir@
datadir		= @datadir@
localstatedir	= @localstatedir@
sharedstatedir	= @sharedstatedir@
sysconfdir	= @sysconfdir@
bindir		= @bindir@
sbindir		= @sbindir@
libexecdir	= @libexecdir@

abs_builddir	= @abs_builddir@
abs_top_srcdir	= @abs_top_srcdir@
abs_top_builddir= @abs_top_builddir@
srcdir          = @srcdir@

SETUP_PY = \
	AC_CFLAGS='${CFLAGS}' \
	AC_LDFLAGS='${LDFLAGS}' \
	AC_LIBS='${LIBS}' \
	AC_SBINDIR='${sbindir}' \
	AC_SCRIPTS='${SCRIPTS}' \
	AC_ABS_BUILDDIR='${abs_builddir}' \
	AC_LIBEXECDIR='${libexecdir}' \
	AC_AUX_SCRIPTS='${AUX_SCRIPTS}' \
	${PYTHON} setup.py

POW_SO	= rpki/POW/_POW.so

SCRIPTS = rpki-sql-backup rpki-sql-setup rpki-start-servers irbe_cli irdbd myrpki \
	  pubd rootd rpkid portal-gui/rpkigui-load-csv portal-gui/rpkigui-add-user \
	  portal-gui/rpkigui-response

AUX_SCRIPTS = portal-gui/rpkigui-list-resources

all: ${POW_SO} rpki/relaxng.py myrpki.rng ${SCRIPTS} ${AUX_SCRIPTS} rpki/gui/settings.py rpki/gui/app/settings.py

${POW_SO}: ext/POW.c setup.py
	${SETUP_PY} build_ext --inplace

clean::
	rm -rf ${POW_SO} build dist

rpm deb:: all
	${SETUP_PY} bdist_rpm

deb::
	cd dist; for i in *.rpm; do case $$i in *.src.rpm) :;; *) (set -x; fakeroot alien -v $$i);; esac; done

rpki/relaxng.py: ../scripts/make-relaxng.py left-right-schema.rng up-down-schema.rng publication-schema.rng
	${PYTHON} ../scripts/make-relaxng.py >$@.tmp
	mv $@.tmp $@

left-right-schema.rng: left-right-schema.rnc
	trang left-right-schema.rnc left-right-schema.rng

up-down-schema.rng: up-down-schema.rnc
	trang up-down-schema.rnc up-down-schema.rng

publication-schema.rng: publication-schema.rnc
	trang publication-schema.rnc publication-schema.rng

myrpki.rng: myrpki.rnc
	trang myrpki.rnc myrpki.rng

clean::
	find . -type f -name '*.py[co]' -delete
	cd tests; $(MAKE) $@
	rm -f ${SCRIPTS} ${AUX_SCRIPTS} rpki/gui/settings.py

install:
	${SETUP_PY} install --record installed

uninstall deinstall:
	xargs rm -fv <installed

distclean::
	rm -f _installed

dont-run-trang:
	touch *.rng

relaxng: left-right-schema.rng up-down-schema.rng publication-schema.rng
	cd tests; $(MAKE) protocol-samples
	xmllint --noout --relaxng  left-right-schema.rng  tests/left-right-protocol-samples/*.xml
	xmllint --noout --relaxng     up-down-schema.rng     tests/up-down-protocol-samples/*.xml
	xmllint --noout --relaxng publication-schema.rng tests/publication-protocol-samples/*.xml

unit-tests: all
	PWD=`pwd`; for i in rpki/*.py; do echo "[$$i]"; PYTHONPATH=$$PWD ${PYWRAP_CMD} $$i; done

all-tests:: unit-tests

all-tests:: relaxng

test all-tests parse-test profile yamltest::
	cd tests; $(MAKE) $@

tags: Makefile
	find . -type f \( -name '*.py' -o -name '*.sql' -o -name '*.rnc' -o -name '*.py.in' \) ! -name relaxng.py ! -name __doc__.py | etags -

lint:
	pylint --rcfile ../scripts/pylint.rc rpki/[a-z]*.py irbe_cli.py irdbd.py pubd.py rootd.py rpkid.py tests/smoketest.py tests/testpoke.py ../myrpki/myrpki.py ../myrpki/yamltest.py

# Documentation

doc/irdbd.dot: irdbd.sql
	sh ../scripts/graphviz-sql.sh $? >$@

doc/pubd.dot: pubd.sql
	sh ../scripts/graphviz-sql.sh $? >$@

doc/rpkid.dot: rpkid.sql
	sh ../scripts/graphviz-sql.sh $? >$@

.SUFFIXES: .dot .png .pdf .eps

.dot.pdf:
	dot -Tps2 $? | ps2pdf - $@

.dot.eps:
	dot -o $@ -Teps $?

.dot.png:
	dot -o $@ -Tpng $?

TEXT_DOCS = Installation Configuration Left-Right Publication MySQL-Setup MyRPKI

dot: doc/irdbd.dot doc/pubd.dot doc/rpkid.dot

eps: doc/irdbd.eps doc/pubd.eps doc/rpkid.eps doc/rpkid-bpki.eps doc/pubd-bpki.eps

png: doc/irdbd.png doc/pubd.png doc/rpkid.png doc/rpkid-bpki.png doc/pubd-bpki.png

docclean:
	rm -rf doc/html doc/latex doc/xml

html: dot eps png
	TZ='' doxygen

tgz: html
	cd doc && tar -cf - html | gzip -9 >manual.tar.gz

text: html
	for i in ${TEXT_DOCS}; do \
		xsltproc --html doc/tweak-doc.xsl doc/html/$$i.html | \
		html2text -rcfile doc/html2textrc -nobs -ascii | \
		awk -f doc/tweak-doc.awk >doc/$$i; \
	done 2>&1 | \
	awk -f doc/suppress-html-parse-errors.awk 1>&2

pdf: doc/irdbd.pdf doc/pubd.pdf doc/rpkid.pdf doc/rpkid-bpki.pdf doc/pubd-bpki.pdf

pdf: html
	cd doc/latex && TZ='' ${MAKE} && ln -f refman.pdf ../manual.pdf

docs: dot eps png html text tgz pdf

distclean:: clean docclean
	cd tests; ${MAKE} $@
	rm -f TAGS rpki/__doc__.py Makefile

COMPILE_COMMON = \
	export AC_PYTHON_INTERPRETER; \
	if test -r $@; then chmod u+w $@; else :; fi; \
	AC_RPKI_CONFIG_DIR='${sysconfdir}' \
	${PYTHON} ${abs_top_srcdir}/buildtools/make-python-executable.py <$? >$@; \
	chmod 555 $@

COMPILE_PYTHON = AC_PYTHON_INTERPRETER='${PYTHON}'; ${COMPILE_COMMON}
COMPILE_PYWRAP = AC_PYTHON_INTERPRETER='${PYWRAP}'; ${COMPILE_COMMON}

COMPILE_SETTINGS = \
	if test -r $@; then chmod u+w $@; else :; fi; \
	AC_DATABASE_PATH='${localstatedir}/rpki/gui.db' \
	AC_SECRET_KEY='${SECRET_KEY}' \
	AC_MYRPKI='${sbindir}/myrpki' \
	AC_LOCALSTATEDIR='${localstatedir}' \
	AC_WEBUSER='${WEBUSER}' \
	${PYTHON} ${abs_top_srcdir}/buildtools/subst-vars.py <$? >$@; \
	chmod 555 $@

rpki-sql-backup: rpki-sql-backup.py
	${COMPILE_PYTHON}

rpki-sql-setup: rpki-sql-setup.py
	${COMPILE_PYTHON}

rpki-start-servers: rpki-start-servers.py
	${COMPILE_PYTHON}

irbe_cli: irbe_cli.py
	${COMPILE_PYWRAP}

irdbd: irdbd.py
	${COMPILE_PYWRAP}

myrpki: myrpki.py
	${COMPILE_PYWRAP}

pubd: pubd.py
	${COMPILE_PYWRAP}

rootd: rootd.py
	${COMPILE_PYWRAP}

rpkid: rpkid.py
	${COMPILE_PYWRAP}

portal-gui/rpkigui-list-resources: portal-gui/list_resources.py
	${COMPILE_PYTHON}

portal-gui/rpkigui-load-csv: portal-gui/load_csv.py
	${COMPILE_PYTHON}

portal-gui/rpkigui-add-user: portal-gui/adduser.py
	${COMPILE_PYTHON}

portal-gui/rpkigui-response: portal-gui/scripts/rpkigui-response.py
	${COMPILE_PYTHON}

rpki/gui/settings.py: ${srcdir}/rpki/gui/settings.py.in
	rm -f $@
	${COMPILE_SETTINGS}

rpki/gui/app/settings.py: ${srcdir}/rpki/gui/app/settings.py.in
	rm -f $@
	${COMPILE_SETTINGS}

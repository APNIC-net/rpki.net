# $Id$
#
# @configure_input@

abs_top_srcdir	 = @abs_top_srcdir@
abs_top_builddir = @abs_top_builddir@
srcdir=@srcdir@
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
localstatedir=@localstatedir@
sharedstatedir=@sharedstatedir@
bindir=@bindir@
sbindir=@sbindir@
libexecdir=@libexecdir@

PYTHON=@PYTHON@
WEBUSER=@WEBUSER@
DJANGO_ADMIN=@DJANGO_ADMIN@

CONFDIR=$(localstatedir)/rpki/conf
DATABASE_PATH=$(localstatedir)/rpki/gui.db
INSTDIR=$(datarootdir)/rpki/gui
TEMPLATEDIR=$(INSTDIR)/templates

# automatically built sources
BUILD=apache/rpki.conf

all: $(BUILD)

clean:
	@true

distclean: clean
	rm -f $(BUILD)
	rm -f Makefile

edit = sed \
	     -e 's|@INSTDIR[@]|$(INSTDIR)|g'

apache/rpki.conf: $(srcdir)/apache/rpki.conf.in Makefile
	$(edit) $@.in > $@

.PHONY: install-perms install-data install install-templates

install-perms:
	chown $(WEBUSER) `dirname $(DATABASE_PATH)`
	chown $(WEBUSER) $(DATABASE_PATH)
	mkdir -p $(CONFDIR)
	chown -R $(WEBUSER) $(CONFDIR)

install-apache:
	install -d -m 755 $(INSTDIR)/apache
	install -m 644 apache/rpki.conf $(INSTDIR)/apache
	install -m 644 apache/rpki.wsgi $(INSTDIR)/apache

install-templates:
	install -d -m 755 $(TEMPLATEDIR)/myrpki
	install -m 644 templates/base.html $(TEMPLATEDIR)
	install -m 644 templates/myrpki/asn_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/child_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/conf_empty.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/conf_list.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/dashboard.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/parent_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/prefix_view.html $(TEMPLATEDIR)/myrpki
	install -m 644 templates/myrpki/xml_import.html $(TEMPLATEDIR)/myrpki
	install -d -m 755 $(TEMPLATEDIR)/registration
	install -m 644 templates/registration/login.html $(TEMPLATEDIR)/registration

install-data: $(BUILD) install-apache install-templates
	mkdir -p `dirname $(DATABASE_PATH)`
	$(DJANGO_ADMIN) syncdb --settings rpki.gui.settings

install: install-data install-perms

deinstall uninstall:
	rm -r $(INSTDIR)

test:
	@true
